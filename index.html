<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evolve Mobile Fix</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { background-color: #121212; color: white; font-family: -apple-system, sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button, select { touch-action: manipulation; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        .btn { border: none; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.05s; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }

        /* --- ç•«é¢ 1: Setup (ä¿æŒåŸæ¨£) --- */
        #screen-select { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #1a1a1a; z-index: 200; position: absolute; width: 100%; }
        .order-selector { display: flex; gap: 15px; margin-bottom: 20px; background: #333; padding: 5px; border-radius: 30px; }
        .order-opt { padding: 8px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; color: #aaa; }
        .order-opt.active { background: #00d2ff; color: #000; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .leader-opt { width: 85px; height: 85px; border-radius: 50%; border: 3px solid #555; overflow: hidden; position: relative; background-size: cover; }
        .leader-opt.selected { border-color: #00d2ff; box-shadow: 0 0 10px #00d2ff; }
        .class-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); font-size: 0.6rem; text-align: center; }
        .upload-btn-rect { width: 200px; height: 40px; background: #333; border-radius: 20px; display: flex; justify-content: center; align-items: center; margin-top: 10px; border: 1px solid #555; position: relative; overflow: hidden; }
        .file-indicator { position: absolute; bottom: 0; left: 0; height: 3px; width: 0%; background: #4eff4e; }

        /* --- ç•«é¢ 2: Battle --- */
        #screen-battle { display: none; flex-direction: row; height: 100%; width: 100%; position: relative; }
        
        /* é ‚éƒ¨å·¥å…·åˆ—å„ªåŒ–ï¼šå¾€ä¸‹ç§»å‹• 40px é¿é–‹ PP æ•¸å€¼ */
        .top-toolbar { position: absolute; top: 45px; left: 5px; z-index: 100; display: flex; flex-direction: column; gap: 5px; }
        .btn-reset { background: #b71c1c; color: white; padding: 5px 10px; font-size: 0.7rem; border-radius: 4px; border: none; }
        .class-select-dropdown { background: #222; color: white; border: 1px solid #555; border-radius: 4px; padding: 3px; font-size: 0.7rem; width: 80px; }

        /* å·¦å´ PP é¢æ¿ */
        .left-panel-pp { width: 28%; background-color: #111; border-right: 2px solid #333; display: flex; flex-direction: column; padding: 5px; box-sizing: border-box; justify-content: space-between; }
        .pp-text-display { font-size: 0.8rem; color: #aaa; text-align: left; padding-left: 5px; }
        .pp-nums { font-size: 1.4rem; color: #fff; font-weight: bold; }
        .pp-nums span { color: #4eff4e; }
        .pp-nums.awakened span { color: #ff9800; text-shadow: 0 0 8px #ff5722; }
        
        .pp-gauge-container { flex-grow: 1; display: flex; flex-direction: column-reverse; align-items: center; gap: 4px; margin: 5px 0; overflow-y: auto; }
        .pp-gem { width: 36px; height: 36px; border-radius: 50%; background: #222; border: 2px solid #444; display: none; justify-content: center; align-items: center; font-size: 0.9rem; font-weight: bold; color: #555; }
        .pp-gem.active { background: radial-gradient(circle at 30% 30%, #4eff4e, #008000); border-color: #ccffcc; color: #004d00; }
        .pp-gem.used { background: #1a1a1a; opacity: 0.4; }
        .pp-gem.active.awakened { background: radial-gradient(circle at 30% 30%, #ffc107, #ff5722); border-color: #ffcc80; }

        .pp-btn-row { display: flex; gap: 3px; }
        .btn-manual { flex: 1; background: #333; border: 1px solid #555; padding: 8px 0; font-size: 0.8rem; border-radius: 5px; }
        .btn-turn-start { width: 100%; padding: 10px 0; background: linear-gradient(135deg, #0056b3, #004494); font-size: 0.9rem; border-radius: 8px; margin-top: 5px; }

        /* å³å´ HP é¢æ¿ - ç¸®å°é ­åƒ */
        .right-panel-hp { width: 72%; display: flex; flex-direction: column; }
        .section-common { height: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .section-enemy { background-color: #251818; border-bottom: 1px solid #444; }
        .section-player { background-color: #181d25; }
        .section-player.awakened-bg { background: radial-gradient(circle at center, #2d1a1a, #181d25); }

        .avatar-container { display: flex; flex-direction: column; align-items: center; position: relative; margin: 0 10px; }
        /* ç¸®å°é ­åƒå°ºå¯¸å¾ 130px -> 100px */
        .avatar-frame { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #fff; object-fit: cover; background: #000; }
        .avatar-player.burning { border-color: #ff9800; animation: burnPulse 1.5s infinite alternate; }
        @keyframes burnPulse { 0% { box-shadow: 0 0 10px #ff5722; } 100% { box-shadow: 0 0 25px #ff9800; } }

        /* è¡€é‡æ•¸å­—æ”¹åœ¨é ­åƒä¸‹æ–¹ */
        .hp-text { font-size: 2.2rem; font-weight: 900; color: #fff; margin-top: -15px; background: rgba(0,0,0,0.5); padding: 0 10px; border-radius: 10px; z-index: 10; text-shadow: 0 0 5px #000; }
        
        .btn-hp { width: 45px; height: 45px; border-radius: 50%; font-size: 1.5rem; background: #444; }
        .btn-minus { background: #b71c1c; }
        .btn-plus { background: #1b5e20; }
        .btn-rotate { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.3); color: white; border: 1px solid #555; padding: 4px 8px; font-size: 0.7rem; border-radius: 4px; }

        .ep-wrapper-left { display: flex; flex-direction: column; align-items: center; margin-right: 8px; }
        .sep-gem { width: 30px; height: 30px; background: #222; border: 1px solid #444; transform: rotate(45deg); display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .sep-gem span { transform: rotate(-45deg); font-size: 0.5rem; }
        .sep-gem.active { background: #e040fb; box-shadow: 0 0 10px #e040fb; color: white; }
        .sep-gem.used { opacity: 0.2; }
        
        .ep-container { display: flex; flex-direction: column-reverse; gap: 5px; }
        .ep-gem { width: 20px; height: 20px; background: #333; border: 1px solid #555; transform: rotate(45deg); opacity: 0.3; }
        .ep-gem.has-ep { opacity: 1; background: #5a4a00; }
        .ep-gem.active { background: #ffd700; opacity: 1; box-shadow: 0 0 5px #ffd700; }

        /* è¨ˆæ•¸å™¨å€å¡Š - èª¿æ•´ä½ç½®é¿å…æ“‹åˆ°éª°å­ */
        .class-counters { position: absolute; bottom: 10px; right: 65px; display: flex; gap: 5px; align-items: flex-end; }
        .counter-box { background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 4px; padding: 2px 4px; text-align: center; min-width: 45px; }
        .counter-label { font-size: 0.5rem; color: #aaa; }
        .counter-val { font-size: 0.9rem; font-weight: bold; }
        .btn-tiny { width: 20px; height: 20px; background: #333; border-radius: 3px; border: 1px solid #555; color: white; font-size: 0.7rem; }
        .btn-toggle { background: #333; color: #888; padding: 2px 5px; border-radius: 3px; font-size: 0.6rem; }
        .btn-toggle.on { background: #b71c1c; color: white; }
        
        .dice-btn { width: 45px; height: 45px; background: white; color: black; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="screen-select">
    <h2 style="color: #00d2ff; margin: 10px 0;">GAME SETUP</h2>
    <div class="order-selector">
        <div class="order-opt active" id="optFirst" onclick="sfx('tick'); setOrder('first')">å…ˆæ”»</div>
        <div class="order-opt" id="optSecond" onclick="sfx('tick'); setOrder('second')">å¾Œæ”»</div>
    </div>
    <div class="grid" id="leaderGrid">
        <div class="leader-opt" onclick="selectLeader(this, 'elf', 'https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf')"><img src="https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf" width="100%"><div class="class-label">ç²¾éˆ</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'royal', 'https://via.placeholder.com/200/FBC02D/000000?text=Royal')"><img src="https://via.placeholder.com/200/FBC02D/000000?text=Royal" width="100%"><div class="class-label">çš‡å®¶</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'witch', 'https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch')"><img src="https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch" width="100%"><div class="class-label">å·«å¸«</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'drag', 'https://via.placeholder.com/200/E65100/FFFFFF?text=Drag')"><img src="https://via.placeholder.com/200/E65100/FFFFFF?text=Drag" width="100%"><div class="class-label">é¾æ—</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'nightmare', 'https://via.placeholder.com/200/B71C1C/FFFFFF?text=Nightmare')"><img src="https://via.placeholder.com/200/B71C1C/FFFFFF?text=Nightmare" width="100%"><div class="class-label">å¤¢é­˜</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'bishop', 'https://via.placeholder.com/200/F0F4C3/000000?text=Bishop')"><img src="https://via.placeholder.com/200/F0F4C3/000000?text=Bishop" width="100%"><div class="class-label">ä¸»æ•™</div></div>
    </div>
    <div class="upload-section">
        <label class="upload-btn-rect" onclick="sfx('click')"><span class="upload-text">ğŸ“· ä¸Šå‚³é ˜è¢–</span><div class="file-indicator" id="imageIndicator"></div><input type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(this)"></label>
        <label class="upload-btn-rect" onclick="sfx('click')"><span class="upload-text">ğŸµ ä¸Šå‚³èªéŸ³</span><div class="file-indicator" id="audioIndicator"></div><input type="file" accept="audio/*" style="display: none;" onchange="handleAudioUpload(this)"></label>
    </div>
    <button class="btn" style="background:#00d2ff; color:#000; padding:12px 50px; border-radius:30px; margin-top:15px; font-weight:bold;" onclick="sfx('confirm'); startGame()">BATTLE START</button>
</div>

<div id="screen-battle">
    <div class="top-toolbar">
        <button class="btn btn-reset" onclick="sfx('click'); resetGame()">RESET</button>
        <select class="class-select-dropdown" id="battleClassSelect" onchange="changeClassInBattle(this.value)">
            <option value="elf">ç²¾éˆ</option><option value="royal">çš‡å®¶</option><option value="witch">å·«å¸«</option><option value="drag">é¾æ—</option><option value="nightmare">å¤¢é­˜</option><option value="bishop">ä¸»æ•™</option>
        </select>
    </div>

    <div class="left-panel-pp">
        <div class="pp-text-display">PP <span class="pp-nums" id="ppNumsDisplay"><span id="currentPP">0</span>/<span id="maxPP">0</span></span></div>
        <div class="pp-gauge-container" id="ppGauge"></div>
        <div class="controls-wrapper">
            <div class="pp-btn-row">
                <button class="btn btn-manual" onclick="modPP(-1)">PP-1</button>
                <button class="btn btn-manual" onclick="modPP(1)">PP+1</button>
            </div>
            <div class="pp-btn-row">
                <button class="btn btn-manual btn-max" onclick="modMaxPP(-1)">M-1</button>
                <button class="btn btn-manual btn-max" onclick="modMaxPP(1)">M+1</button>
            </div>
            <button class="btn btn-turn-start" onclick="sfx('powerup'); startTurn()">å›åˆé–‹å§‹</button>
        </div>
        <div style="text-align: center; color: #444; font-size: 0.6rem;">Turn: <span id="turnCount">0</span></div>
    </div>

    <div class="right-panel-hp">
        <div class="section-common section-enemy" id="enemySection">
            <button class="btn btn-rotate" onclick="sfx('tick'); rotateEnemy()">â†»</button>
            <button class="btn btn-hp btn-minus" onclick="modHP('enemy',-1)">-</button>
            <div class="avatar-container">
                <img src="https://via.placeholder.com/150/333/FFF?text=Enemy" class="avatar-frame">
                <div class="hp-text" id="enemyHP">20</div>
            </div>
            <button class="btn btn-hp btn-plus" onclick="modHP('enemy',1)">+</button>
        </div>
        <div class="section-common section-player" id="playerSection">
            <div class="ep-wrapper-left">
                <div class="sep-gem" id="sepGem" onclick="toggleSEP()"><span>SEP</span></div>
                <div class="ep-container" id="epBox">
                    <div class="ep-gem" onclick="toggleEP(this)"></div><div class="ep-gem" onclick="toggleEP(this)"></div><div class="ep-gem" onclick="toggleEP(this)"></div>
                </div>
            </div>
            <button class="btn btn-hp btn-minus" onclick="modHP('player',-1)">-</button>
            <div class="avatar-container">
                <img id="myAvatar" src="" class="avatar-frame avatar-player" onclick="playUserVoice()">
                <div class="hp-text" id="playerHP">20</div>
            </div>
            <button class="btn btn-hp btn-plus" onclick="modHP('player',1)">+</button>
            <div class="class-counters" id="classCounters"></div>
            <div class="dice-container" onclick="rollDice()"><div class="dice-btn" id="diceResult">ğŸ²</div></div>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let uploadedAudio = new Audio();
    let hasUploadedAudio = false;

    function sfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'click') { osc.type = 'square'; osc.frequency.setValueAtTime(400, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'tick') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.05, now); osc.start(now); osc.stop(now + 0.05); }
        else if (type === 'confirm') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.2); }
        else if (type === 'powerup') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.4); }
    }

    let state = {
        playerHP: 20, enemyHP: 20, currentPP: 0, maxPP: 0, turn: 0,
        imgSrc: '', uploadedImgSrc: '', playerClass: 'elf',
        isFirstPlayer: true, sepUsed: false,
        combo: 0, cemetery: 0, spellboost: 0, necroCharge: 0, isCrimson: false, isImprisoned: false
    };

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                state.uploadedImgSrc = e.target.result; state.imgSrc = e.target.result;
                document.getElementById('imageIndicator').style.width = "100%"; sfx('confirm');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function handleAudioUpload(input) {
        if (input.files && input.files[0]) {
            uploadedAudio.src = URL.createObjectURL(input.files[0]);
            uploadedAudio.load(); hasUploadedAudio = true;
            document.getElementById('audioIndicator').style.width = "100%"; sfx('confirm');
        }
    }

    function playUserVoice() { if (hasUploadedAudio) { uploadedAudio.currentTime = 0; uploadedAudio.play(); } else { sfx('tick'); } }

    function selectLeader(el, cls, def) {
        document.querySelectorAll('.leader-opt').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        state.playerClass = cls; state.imgSrc = state.uploadedImgSrc || def;
        sfx('tick');
    }

    function setOrder(order) {
        state.isFirstPlayer = (order === 'first');
        document.getElementById('optFirst').className = state.isFirstPlayer ? 'order-opt active' : 'order-opt';
        document.getElementById('optSecond').className = !state.isFirstPlayer ? 'order-opt active' : 'order-opt';
    }

    function startGame() {
        if (!state.imgSrc) { alert("è«‹é¸è·æ¥­æˆ–ä¸Šå‚³é ˜è¢–"); return; }
        document.getElementById('myAvatar').src = state.imgSrc;
        document.getElementById('battleClassSelect').value = state.playerClass;
        document.getElementById('screen-select').style.display = 'none';
        document.getElementById('screen-battle').style.display = 'flex';
        initGauge(); renderClassUI(); updateEPUi(); updateSEPUi();
    }

    function initGauge() {
        const container = document.getElementById('ppGauge'); container.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            let gem = document.createElement('div'); gem.className = 'pp-gem'; gem.innerText = i; gem.dataset.index = i;
            gem.onclick = () => { sfx('click'); togglePP(i); }; container.appendChild(gem);
        }
        renderPP();
    }

    function togglePP(idx) { state.currentPP = (state.currentPP >= idx) ? idx - 1 : idx; renderPP(); }
    function modPP(val) { state.currentPP = Math.max(0, Math.min(state.maxPP, state.currentPP + val)); renderPP(); sfx('click'); }
    function modMaxPP(val) { state.maxPP = Math.max(0, Math.min(10, state.maxPP + val)); if(state.currentPP > state.maxPP) state.currentPP = state.maxPP; renderPP(); sfx('click'); }

    function renderPP() {
        document.getElementById('currentPP').innerText = state.currentPP;
        document.getElementById('maxPP').innerText = state.maxPP;
        const isAwakened = (state.playerClass === 'drag' && state.maxPP >= 7);
        const ppNums = document.getElementById('ppNumsDisplay');
        const avatar = document.getElementById('myAvatar');
        const section = document.getElementById('playerSection');

        if(isAwakened) { ppNums.classList.add('awakened'); avatar.classList.add('burning'); section.classList.add('awakened-bg'); }
        else { ppNums.classList.remove('awakened'); avatar.classList.remove('burning'); section.classList.remove('awakened-bg'); }

        document.querySelectorAll('.pp-gem').forEach((gem) => {
            const num = parseInt(gem.dataset.index);
            if (num <= state.maxPP) {
                gem.style.display = 'flex';
                gem.className = (num <= state.currentPP) ? 'pp-gem active' : 'pp-gem used';
                if (isAwakened && num <= state.currentPP) gem.classList.add('awakened');
            } else { gem.style.display = 'none'; }
        });
    }

    function startTurn() {
        state.turn++; if (state.maxPP < 10) state.maxPP++;
        state.currentPP = state.maxPP;
        if (state.playerClass === 'elf') state.combo = 0;
        if (state.playerClass === 'nightmare') state.isCrimson = false;
        document.getElementById('turnCount').innerText = state.turn;
        renderPP(); renderClassUI(); updateSEPUi();
    }

    function updateSEPUi() {
        const canUse = (state.isFirstPlayer && state.turn >= 7) || (!state.isFirstPlayer && state.turn >= 6);
        const sep = document.getElementById('sepGem');
        sep.className = !canUse ? 'sep-gem' : (state.sepUsed ? 'sep-gem used' : 'sep-gem active');
    }

    function toggleSEP() { if(document.getElementById('sepGem').classList.contains('active')) { state.sepUsed = true; sfx('powerup'); updateSEPUi(); } }

    function updateEPUi() {
        const eps = document.getElementById('epBox').children;
        const count = state.isFirstPlayer ? 0 : 3;
        for(let i=0; i<3; i++) { eps[i].className = (i < count) ? 'ep-gem has-ep active' : 'ep-gem'; }
    }

    function toggleEP(el) { if(el.classList.contains('has-ep')) el.classList.toggle('active'); }

    function modHP(who, val) { state[who+'HP'] += val; document.getElementById(who+'HP').innerText = state[who+'HP']; sfx('click'); }

    function renderClassUI() {
        const container = document.getElementById('classCounters'); container.innerHTML = '';
        const addC = (lbl, key) => {
            let div = document.createElement('div'); div.className='counter-box';
            div.innerHTML = `<div class="counter-label">${lbl}</div><div style="display:flex;align-items:center;gap:3px"><button class="btn-tiny" onclick="modCounter('${key}',-1)">-</button><span class="counter-val" id="v-${key}">${state[key]}</span><button class="btn-tiny" onclick="modCounter('${key}',1)">+</button></div>`;
            container.appendChild(div);
        };
        const addT = (lbl, key, style) => {
            let div = document.createElement('div'); div.className='counter-box';
            div.innerHTML = `<div class="counter-label">${lbl}</div><button class="btn-toggle ${state[key]?'on':''} ${style||''}" onclick="togState('${key}')">${state[key]?'ON':'OFF'}</button>`;
            container.appendChild(div);
        };
        addT('åç‰¢', 'isImprisoned', 'prison');
        if(state.playerClass==='elf') addC('é€£æ“Š','combo');
        if(['royal','witch','nightmare'].includes(state.playerClass)) addC('å¢“å ´','cemetery');
        if(state.playerClass==='witch') addC('å¢å¹…','spellboost');
        if(state.playerClass==='nightmare') { addT('çœŸç´…','isCrimson'); addC('å……èƒ½','necroCharge'); }
    }

    window.modCounter = (k, v) => { state[k]=Math.max(0, state[k]+v); document.getElementById('v-'+k).innerText=state[k]; sfx('click'); };
    window.togState = (k) => { state[k]=!state[k]; sfx('tick'); renderClassUI(); };
    function changeClassInBattle(v) { state.playerClass=v; sfx('confirm'); renderClassUI(); renderPP(); }

    function rollDice() {
        const d = document.getElementById('diceResult'); sfx('click');
        let count = 0; let inv = setInterval(() => { d.innerText = Math.floor(Math.random()*6)+1; if(count++ > 6) clearInterval(inv); }, 50);
    }

    let isRotated = false;
    function rotateEnemy() { isRotated = !isRotated; document.getElementById('enemySection').style.transform = isRotated ? "rotate(180deg)" : "none"; }
    function resetGame() { if(confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) location.reload(); }
</script>
</body>
</html>
