<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evolve Class Mechanics - FULL RECOVERY</title>
    <style>
        /* --- ÂÖ®Â±ÄË®≠ÂÆö --- */
        body { background-color: #121212; color: white; font-family: -apple-system, sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button, select { touch-action: manipulation; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        .btn { border: none; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.05s; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }

        /* --- Áï´Èù¢ 1: Setup --- */
        #screen-select { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #1a1a1a; z-index: 50; position: absolute; width: 100%; }
        .order-selector { display: flex; gap: 20px; margin-bottom: 20px; background: #333; padding: 5px; border-radius: 30px; }
        .order-opt { padding: 10px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; color: #aaa; transition: all 0.2s; }
        .order-opt.active { background: #00d2ff; color: #000; box-shadow: 0 0 10px rgba(0, 210, 255, 0.5); }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px; }
        .leader-opt { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #555; overflow: hidden; position: relative; cursor: pointer; background-size: cover; background-position: center; transition: transform 0.1s; }
        .leader-opt.selected { border-color: #00d2ff; box-shadow: 0 0 15px #00d2ff; transform: scale(1.1); }
        .class-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); font-size: 0.7rem; text-align: center; padding: 3px 0; pointer-events: none; }
        
        .upload-section { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .upload-btn-rect { width: 220px; height: 45px; background: #333; border-radius: 25px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #555; position: relative; overflow: hidden; }
        .upload-text { font-size: 0.9rem; color: #ccc; z-index: 2; pointer-events: none; font-weight: bold; }
        .file-indicator { position: absolute; bottom: 0; left: 0; height: 4px; width: 0%; background: #4eff4e; transition: width 0.3s; }

        /* --- Áï´Èù¢ 2: Battle --- */
        #screen-battle { display: none; flex-direction: row; height: 100%; width: 100%; position: relative; }
        .top-toolbar { position: absolute; top: 10px; left: 10px; z-index: 100; display: flex; gap: 8px; }
        .btn-reset { background: #b71c1c; color: white; padding: 8px 15px; font-size: 0.8rem; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .class-select-dropdown { background: #333; color: white; border: 1px solid #555; border-radius: 5px; padding: 5px; font-size: 0.8rem; }

        /* Â∑¶ÂÅ¥ PP Èù¢Êùø */
        .left-panel-pp { width: 30%; background-color: #111; border-right: 2px solid #333; display: flex; flex-direction: column; padding: 10px 5px; box-sizing: border-box; justify-content: space-between; }
        .pp-text-display { font-size: 0.9rem; color: #aaa; text-align: center; margin-bottom: 5px; }
        .pp-nums { font-size: 1.5rem; color: #fff; font-weight: bold; }
        .pp-nums span { color: #4eff4e; transition: color 0.5s; }
        .pp-nums.awakened span { color: #ff9800; text-shadow: 0 0 10px #ff5722; }
        
        .pp-gauge-container { flex-grow: 1; display: flex; flex-direction: column-reverse; justify-content: flex-start; align-items: center; gap: 6px; width: 100%; margin: 5px 0; overflow-y: auto; }
        .pp-gem { width: 42px; height: 42px; border-radius: 50%; background: #222; border: 2px solid #444; cursor: pointer; position: relative; display: none; justify-content: center; align-items: center; font-size: 1.1rem; font-weight: bold; color: #555; transition: all 0.3s; }
        .pp-gem.active { background: radial-gradient(circle at 30% 30%, #4eff4e, #008000); border-color: #ccffcc; box-shadow: 0 0 10px #4eff4e; color: #004d00; transform: scale(1.05); }
        .pp-gem.used { background: #1a1a1a; border-color: #555; opacity: 0.6; color: #444; transform: scale(0.95); }
        .pp-gem.active.awakened { background: radial-gradient(circle at 30% 30%, #ffc107, #ff5722); border-color: #ffcc80; box-shadow: 0 0 15px #ff6f00; color: #5d0000; }

        /* PP ÊåâÈàïÊéßÂà∂ÂçÄ */
        .controls-wrapper { display: flex; flex-direction: column; gap: 8px; width: 100%; padding: 0 5px; box-sizing: border-box; }
        .pp-btn-row { display: flex; gap: 5px; width: 100%; }
        .btn-manual { flex: 1; background: #333; border: 1px solid #555; padding: 10px 0; font-size: 1rem; border-radius: 8px; }
        .btn-max { background: #222; font-size: 0.9rem; color: #bbb; }
        .btn-turn-start { width: 100%; padding: 15px 0; background: linear-gradient(135deg, #0056b3, #004494); font-size: 1rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.4); }

        /* Âè≥ÂÅ¥ HP Èù¢Êùø */
        .right-panel-hp { width: 70%; display: flex; flex-direction: column; }
        .section-common { height: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .section-enemy { background-color: #251818; border-bottom: 2px solid #444; }
        .section-player { background-color: #181d25; transition: background 1s; }
        .section-player.awakened-bg { background: radial-gradient(circle at center, #2d1a1a, #181d25); }

        .controls-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .avatar-frame { width: 130px; height: 130px; border-radius: 50%; border: 4px solid #fff; object-fit: cover; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .avatar-player.burning { border-color: #ffcc80; animation: burnPulse 1.5s infinite alternate; }
        @keyframes burnPulse { 0% { box-shadow: 0 0 15px #ff5722; transform: scale(1); } 100% { box-shadow: 0 0 35px #ff9800; transform: scale(1.02); } }
        
        .hp-text { font-size: 3.5rem; font-weight: 800; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); position: absolute; bottom: -10px; right: -10px; z-index: 10; }
        .btn-hp { width: 55px; height: 55px; border-radius: 50%; font-size: 2rem; background: #444; }
        .btn-minus { background: #b71c1c; }
        .btn-plus { background: #1b5e20; }
        .btn-rotate { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 5px; z-index: 100; }

        /* EP & SEP */
        .ep-wrapper-left { display: flex; flex-direction: column; align-items: center; margin-right: 15px; }
        .sep-gem { width: 35px; height: 35px; background: #222; border: 2px solid #444; transform: rotate(45deg); display: flex; justify-content: center; align-items: center; margin-bottom: 15px; transition: all 0.3s; }
        .sep-gem span { transform: rotate(-45deg); font-size: 0.6rem; font-weight: bold; }
        .sep-gem.active { background: radial-gradient(circle at 30% 30%, #e040fb, #7b1fa2); border-color: #ff80ab; box-shadow: 0 0 15px #e040fb; color: white; animation: pulseSep 2s infinite; }
        .sep-gem.used { opacity: 0.2; background: #000; }
        @keyframes pulseSep { 0%, 100% { transform: rotate(45deg) scale(1); } 50% { transform: rotate(45deg) scale(1.15); } }
        
        .ep-container { display: flex; flex-direction: column-reverse; gap: 8px; }
        .ep-gem { width: 24px; height: 24px; background: #333; border: 2px solid #555; transform: rotate(45deg); opacity: 0.3; transition: all 0.2s; }
        .ep-gem.has-ep { opacity: 1; background: #5a4a00; border-color: #887000; }
        .ep-gem.active { background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00); border-color: #ffffaa; box-shadow: 0 0 8px #ffd700; opacity: 1; }

        /* ËÅ∑Ê•≠Ë®àÊï∏Âô® */
        .class-counters { position: absolute; bottom: 15px; right: 80px; display: flex; gap: 8px; align-items: flex-end; z-index: 20; }
        .counter-box { background: rgba(0,0,0,0.85); border: 1px solid #555; border-radius: 6px; padding: 4px 6px; text-align: center; min-width: 55px; }
        .counter-label { font-size: 0.6rem; color: #aaa; margin-bottom: 2px; }
        .counter-val { font-size: 1.1rem; font-weight: bold; color: white; }
        .btn-tiny { width: 24px; height: 24px; background: #333; border-radius: 4px; border: 1px solid #555; color: white; }
        .btn-toggle { background: #333; border: 1px solid #666; color: #888; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }
        .btn-toggle.on { background: #b71c1c; color: white; border-color: #ff5252; box-shadow: 0 0 5px #b71c1c; }
        .btn-toggle.prison.on { background: #4a148c; border-color: #ea80fc; }
        
        .dice-container { position: absolute; bottom: 15px; right: 15px; z-index: 20; }
        .dice-btn { width: 50px; height: 50px; background: white; color: black; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; box-shadow: 0 2px 5px #000; }
    </style>
</head>
<body>

<div id="screen-select">
    <h2 style="color: #00d2ff; margin-bottom: 10px;">GAME SETUP</h2>
    <div class="order-selector">
        <div class="order-opt active" id="optFirst" onclick="sfx('tick'); setOrder('first')">ÂÖàÊîª (1st)</div>
        <div class="order-opt" id="optSecond" onclick="sfx('tick'); setOrder('second')">ÂæåÊîª (2nd)</div>
    </div>
    <div class="grid">
        <div class="leader-opt" onclick="selectLeader(this, 'elf', 'https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf')"><img src="https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf"><div class="class-label">Á≤æÈùà</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'royal', 'https://via.placeholder.com/200/FBC02D/000000?text=Royal')"><img src="https://via.placeholder.com/200/FBC02D/000000?text=Royal"><div class="class-label">ÁöáÂÆ∂</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'witch', 'https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch')"><img src="https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch"><div class="class-label">Â∑´Â∏´</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'drag', 'https://via.placeholder.com/200/E65100/FFFFFF?text=Drag')"><img src="https://via.placeholder.com/200/E65100/FFFFFF?text=Drag"><div class="class-label">ÈæçÊóè</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'nightmare', 'https://via.placeholder.com/200/B71C1C/FFFFFF?text=Nightmare')"><img src="https://via.placeholder.com/200/B71C1C/FFFFFF?text=Nightmare"><div class="class-label">Â§¢È≠ò</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'bishop', 'https://via.placeholder.com/200/F0F4C3/000000?text=Bishop')"><img src="https://via.placeholder.com/200/F0F4C3/000000?text=Bishop"><div class="class-label">‰∏ªÊïô</div></div>
    </div>
    <div class="upload-section">
        <label class="upload-btn-rect" onclick="sfx('click')"><span class="upload-text">üì∑ ‰∏äÂÇ≥Ëá™Ë®ÇÈ†òË¢ñ</span><div class="file-indicator" id="imageIndicator"></div><input type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(this)"></label>
        <label class="upload-btn-rect" onclick="sfx('click')"><span class="upload-text">üéµ ‰∏äÂÇ≥Ëá™Ë®ÇË™ûÈü≥</span><div class="file-indicator" id="audioIndicator"></div><input type="file" accept="audio/*" style="display: none;" onchange="handleAudioUpload(this)"></label>
    </div>
    <button class="btn" style="background:#00d2ff; color:#000; padding:15px 60px; border-radius:30px; margin-top:20px; font-size:1.2rem;" onclick="sfx('confirm'); startGame()">BATTLE START</button>
</div>

<div id="screen-battle">
    <div class="top-toolbar">
        <button class="btn btn-reset" onclick="sfx('click'); resetGame()">RESET</button>
        <select class="class-select-dropdown" id="battleClassSelect" onchange="changeClassInBattle(this.value)">
            <option value="elf">Á≤æÈùà (Elf)</option><option value="royal">ÁöáÂÆ∂ (Royal)</option><option value="witch">Â∑´Â∏´ (Witch)</option><option value="drag">ÈæçÊóè (Drag)</option><option value="nightmare">Â§¢È≠ò (Nightmare)</option><option value="bishop">‰∏ªÊïô (Bishop)</option>
        </select>
    </div>

    <div class="left-panel-pp">
        <div class="pp-text-display">PP <span class="pp-nums" id="ppNumsDisplay"><span id="currentPP">0</span>/<span id="maxPP">0</span></span></div>
        <div class="pp-gauge-container" id="ppGauge"></div>
        <div class="controls-wrapper">
            <div class="pp-btn-row">
                <button class="btn btn-manual" onclick="sfx('click'); modPP(-1)">PP -1</button>
                <button class="btn btn-manual" onclick="sfx('click'); modPP(1)">PP +1</button>
            </div>
            <div class="pp-btn-row">
                <button class="btn btn-manual btn-max" onclick="sfx('click'); modMaxPP(-1)">Max -1</button>
                <button class="btn btn-manual btn-max" onclick="sfx('click'); modMaxPP(1)">Max +1</button>
            </div>
            <button class="btn btn-turn-start" onclick="sfx('powerup'); startTurn()">ÂõûÂêàÈñãÂßã<br><span style="font-size:0.7rem; font-weight:normal;">TURN START</span></button>
        </div>
        <div style="text-align: center; color: #666; font-size: 0.7rem;">Turn: <span id="turnCount">0</span></div>
    </div>

    <div class="right-panel-hp">
        <div class="section-common section-enemy" id="enemySection">
            <button class="btn btn-rotate" onclick="sfx('tick'); rotateEnemy()">‚Üª</button>
            <div class="controls-container">
                <button class="btn btn-hp btn-minus" onclick="sfx('click'); modHP('enemy',-1)">-</button>
                <div style="position:relative;"><img src="https://via.placeholder.com/150/333/FFF?text=Enemy" class="avatar-frame"><div class="hp-text" id="enemyHP">20</div></div>
                <button class="btn btn-hp btn-plus" onclick="sfx('click'); modHP('enemy',1)">+</button>
            </div>
        </div>
        <div class="section-common section-player" id="playerSection">
            <div class="controls-container">
                <div class="ep-wrapper-left">
                    <div class="sep-gem" id="sepGem" onclick="sfx('tick'); toggleSEP()"><span>SEP</span></div>
                    <div class="ep-container" id="epBox">
                        <div class="ep-gem" onclick="sfx('tick'); toggleEP(this)"></div><div class="ep-gem" onclick="sfx('tick'); toggleEP(this)"></div><div class="ep-gem" onclick="sfx('tick'); toggleEP(this)"></div>
                    </div>
                </div>
                <button class="btn btn-hp btn-minus" onclick="sfx('click'); modHP('player',-1)">-</button>
                <div style="position:relative;"><img id="myAvatar" src="" class="avatar-frame avatar-player" onclick="playUserVoice()"><div class="hp-text" id="playerHP">20</div></div>
                <button class="btn btn-hp btn-plus" onclick="sfx('click'); modHP('player',1)">+</button>
            </div>
            <div class="class-counters" id="classCounters"></div>
            <div class="dice-container" onclick="rollDice()"><div class="dice-btn" id="diceResult">üé≤</div></div>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let uploadedAudio = new Audio();
    let hasUploadedAudio = false;

    function sfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'click') { osc.type = 'square'; osc.frequency.setValueAtTime(400, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'tick') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gainNode.gain.setValueAtTime(0.05, now); osc.start(now); osc.stop(now + 0.05); }
        else if (type === 'confirm') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.2); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.2); }
        else if (type === 'powerup') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(600, now + 0.4); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.4); }
    }

    let state = {
        playerHP: 20, enemyHP: 20, currentPP: 0, maxPP: 0, turn: 0,
        imgSrc: '', uploadedImgSrc: '', playerClass: '',
        isFirstPlayer: true, sepUsed: false,
        combo: 0, cemetery: 0, spellboost: 0, necroCharge: 0, isCrimson: false, isImprisoned: false
    };

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                state.uploadedImgSrc = e.target.result; 
                state.imgSrc = e.target.result;
                document.getElementById('imageIndicator').style.width = "100%"; 
                sfx('confirm');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function handleAudioUpload(input) {
        if (input.files && input.files[0]) {
            uploadedAudio.src = URL.createObjectURL(input.files[0]);
            uploadedAudio.load(); hasUploadedAudio = true;
            document.getElementById('audioIndicator').style.width = "100%";
            sfx('confirm');
        }
    }

    function playUserVoice() { if (hasUploadedAudio) { uploadedAudio.currentTime = 0; uploadedAudio.play(); } else { sfx('tick'); } }

    function selectLeader(el, cls, def) {
        document.querySelectorAll('.leader-opt').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        state.playerClass = cls;
        state.imgSrc = state.uploadedImgSrc || def;
        sfx('tick');
    }

    function setOrder(order) {
        state.isFirstPlayer = (order === 'first');
        document.getElementById('optFirst').className = state.isFirstPlayer ? 'order-opt active' : 'order-opt';
        document.getElementById('optSecond').className = !state.isFirstPlayer ? 'order-opt active' : 'order-opt';
    }

    function startGame() {
        if (!state.imgSrc) { alert("Ë´ãÈÅ∏ÊìáËÅ∑Ê•≠Êàñ‰∏äÂÇ≥ÂúñÁâá"); return; }
        document.getElementById('myAvatar').src = state.imgSrc;
        document.getElementById('battleClassSelect').value = state.playerClass || 'elf';
        if(!state.playerClass) state.playerClass = 'elf';
        document.getElementById('screen-select').style.display = 'none';
        document.getElementById('screen-battle').style.display = 'flex';
        initGauge(); renderClassUI(); updateEPUi(); updateSEPUi();
    }

    function initGauge() {
        const container = document.getElementById('ppGauge'); container.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            let gem = document.createElement('div'); gem.className = 'pp-gem'; gem.innerText = i; gem.dataset.index = i;
            gem.onclick = () => { sfx('click'); togglePP(i); }; container.appendChild(gem);
        }
        renderPP();
    }

    function togglePP(idx) { state.currentPP = (state.currentPP >= idx) ? idx - 1 : idx; renderPP(); }
    function modPP(val) { state.currentPP = Math.max(0, Math.min(state.maxPP, state.currentPP + val)); renderPP(); }
    function modMaxPP(val) { state.maxPP = Math.max(0, Math.min(10, state.maxPP + val)); if(state.currentPP > state.maxPP) state.currentPP = state.maxPP; renderPP(); }

    function renderPP() {
        document.getElementById('currentPP').innerText = state.currentPP;
        document.getElementById('maxPP').innerText = state.maxPP;
        const isAwakened = (state.playerClass === 'drag' && state.maxPP >= 7);
        const ppNums = document.getElementById('ppNumsDisplay');
        const avatar = document.getElementById('myAvatar');
        const section = document.getElementById('playerSection');

        if(isAwakened) { ppNums.classList.add('awakened'); avatar.classList.add('burning'); section.classList.add('awakened-bg'); }
        else { ppNums.classList.remove('awakened'); avatar.classList.remove('burning'); section.classList.remove('awakened-bg'); }

        document.querySelectorAll('.pp-gem').forEach((gem) => {
            const num = parseInt(gem.dataset.index);
            if (num <= state.maxPP) {
                gem.style.display = 'flex';
                gem.className = (num <= state.currentPP) ? 'pp-gem active' : 'pp-gem used';
                if (isAwakened && num <= state.currentPP) gem.classList.add('awakened');
            } else { gem.style.display = 'none'; }
        });
    }

    function startTurn() {
        state.turn++; if (state.maxPP < 10) state.maxPP++;
        state.currentPP = state.maxPP;
        if (state.playerClass === 'elf') { state.combo = 0; }
        if (state.playerClass === 'nightmare') { state.isCrimson = false; }
        document.getElementById('turnCount').innerText = state.turn;
        renderPP(); renderClassUI(); updateSEPUi();
    }

    function updateSEPUi() {
        const canUse = (state.isFirstPlayer && state.turn >= 7) || (!state.isFirstPlayer && state.turn >= 6);
        const sep = document.getElementById('sepGem');
        sep.className = !canUse ? 'sep-gem' : (state.sepUsed ? 'sep-gem used' : 'sep-gem active');
    }

    function toggleSEP() { if(document.getElementById('sepGem').classList.contains('active')) { state.sepUsed = true; sfx('powerup'); updateSEPUi(); } }

    function updateEPUi() {
        const eps = document.getElementById('epBox').children;
        const count = state.isFirstPlayer ? 0 : 3;
        for(let i=0; i<3; i++) { eps[i].className = (i < count) ? 'ep-gem has-ep active' : 'ep-gem'; }
    }

    function toggleEP(el) { if(el.classList.contains('has-ep')) el.classList.toggle('active'); }

    function modHP(who, val) { state[who+'HP'] += val; document.getElementById(who+'HP').innerText = state[who+'HP']; }

    function renderClassUI() {
        const container = document.getElementById('classCounters'); container.innerHTML = '';
        const addC = (lbl, key) => {
            let div = document.createElement('div'); div.className='counter-box';
            div.innerHTML = `<div class="counter-label">${lbl}</div><div style="display:flex;align-items:center;gap:4px"><button class="btn-tiny" onclick="modCounter('${key}',-1)">-</button><span class="counter-val" id="v-${key}">${state[key]}</span><button class="btn-tiny" onclick="modCounter('${key}',1)">+</button></div>`;
            container.appendChild(div);
        };
        const addT = (lbl, key, style) => {
            let div = document.createElement('div'); div.className='counter-box';
            div.innerHTML = `<div class="counter-label">${lbl}</div><button class="btn-toggle ${state[key]?'on':''} ${style||''}" onclick="togState('${key}')">${state[key]?'ON':'OFF'}</button>`;
            container.appendChild(div);
        };
        addT('ÂùêÁâ¢', 'isImprisoned', 'prison');
        if(state.playerClass==='elf') addC('ÈÄ£Êìä','combo');
        if(['royal','witch','nightmare'].includes(state.playerClass)) addC('Â¢ìÂ†¥','cemetery');
        if(state.playerClass==='witch') addC('Â¢ûÂπÖ','spellboost');
        if(state.playerClass==='nightmare') { addT('ÁúüÁ¥Ö','isCrimson'); addC('ÂÖÖËÉΩ','necroCharge'); }
    }

    window.modCounter = (k, v) => { state[k]=Math.max(0, state[k]+v); document.getElementById('v-'+k).innerText=state[k]; sfx('click'); };
    window.togState = (k) => { state[k]=!state[k]; sfx('tick'); renderClassUI(); };
    function changeClassInBattle(v) { state.playerClass=v; sfx('confirm'); renderClassUI(); renderPP(); }

    function rollDice() {
        const d = document.getElementById('diceResult'); sfx('click');
        let count = 0; let inv = setInterval(() => { d.innerText = Math.floor(Math.random()*6)+1; if(count++ > 6) clearInterval(inv); }, 50);
    }

    let isRotated = false;
    function rotateEnemy() { isRotated = !isRotated; document.getElementById('enemySection').style.transform = isRotated ? "rotate(180deg)" : "none"; }
    function resetGame() { if(confirm("Á¢∫ÂÆöÈáçÁΩÆÈÅäÊà≤Ôºü")) location.reload(); }
</script>
</body>
</html>
