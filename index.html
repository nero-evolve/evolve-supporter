<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evolve Final Tool</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { background-color: #121212; color: white; font-family: -apple-system, sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button { touch-action: manipulation; outline: none; -webkit-tap-highlight-color: transparent; }
        .btn { border: none; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }

        /* --- ç•«é¢ 1: é¸æ“‡ --- */
        #screen-select { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #1a1a1a; z-index: 50; position: absolute; width: 100%; }
        
        /* å…ˆæ”»å¾Œæ”»é¸æ“‡å™¨ */
        .order-selector { display: flex; gap: 20px; margin-bottom: 20px; background: #333; padding: 5px; border-radius: 30px; }
        .order-opt { padding: 10px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; color: #aaa; transition: all 0.2s; }
        .order-opt.active { background: #00d2ff; color: #000; box-shadow: 0 0 10px rgba(0, 210, 255, 0.5); }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .leader-opt { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #555; overflow: hidden; position: relative; cursor: pointer; background-size: cover; background-position: center; }
        .leader-opt.selected { border-color: #00d2ff; box-shadow: 0 0 15px #00d2ff; transform: scale(1.1); }
        .class-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); font-size: 0.6rem; text-align: center; padding: 2px 0; pointer-events: none; }
        .upload-btn { background: #333; display: flex; justify-content: center; align-items: center; }
        .upload-icon { font-size: 30px; color: #aaa; pointer-events: none; }

        /* --- ç•«é¢ 2: æˆ°é¬¥ (å·¦å³ä½ˆå±€) --- */
        #screen-battle { display: none; flex-direction: row; height: 100%; width: 100%; }
        
        /* === å·¦å´ï¼šPP æ§åˆ¶å€ === */
        .left-panel-pp { 
            width: 30%; background-color: #111; border-right: 2px solid #333; 
            display: flex; flex-direction: column; padding: 10px 5px; box-sizing: border-box; justify-content: space-between;
        }
        .pp-text-display { font-size: 0.9rem; color: #aaa; text-align: center; margin-bottom: 5px; }
        .pp-nums { font-size: 1.5rem; color: #fff; font-weight: bold; }
        .pp-nums span { color: #4eff4e; }
        
        .pp-gauge-container {
            flex-grow: 1; display: flex; flex-direction: column-reverse; 
            justify-content: flex-start; align-items: center;
            gap: 6px; width: 100%; margin: 5px 0; overflow-y: auto;
        }
        .pp-gem {
            width: 42px; height: 42px; border-radius: 50%; background: #222; border: 2px solid #444;
            cursor: pointer; position: relative; display: none; justify-content: center; align-items: center;
            font-size: 1.1rem; font-weight: bold; color: #555; transition: all 0.2s;
        }
        .pp-gem[style*="display: none"] { display: none !important; }
        .pp-gem.active { background: radial-gradient(circle at 30% 30%, #4eff4e, #008000); border-color: #ccffcc; box-shadow: 0 0 10px #4eff4e; color: #004d00; transform: scale(1.05); }
        .pp-gem.used { background: #1a1a1a; border-color: #555; opacity: 0.6; color: #444; transform: scale(0.95); }

        .controls-wrapper { display: flex; flex-direction: column; gap: 8px; width: 100%; padding: 0 5px; box-sizing: border-box; }
        .pp-btn-row { display: flex; gap: 5px; width: 100%; }
        .btn-manual { flex: 1; background: #333; border: 1px solid #555; padding: 10px 0; font-size: 1rem; border-radius: 8px; }
        .btn-max { background: #222; font-size: 0.9rem; color: #bbb; }
        .btn-turn-start { width: 100%; padding: 15px 0; background: linear-gradient(135deg, #0056b3, #004494); font-size: 1rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.4); }

        /* === å³å´ï¼šHP èˆ‡å¤§åœ– === */
        .right-panel-hp { width: 70%; display: flex; flex-direction: column; }
        .section-enemy { height: 40%; background-color: #251818; border-bottom: 2px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
        .section-player { height: 60%; background-color: #181d25; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* ç©å®¶æ“ä½œå€å®¹å™¨ */
        .player-controls-container { display: flex; align-items: center; justify-content: center; width: 100%; padding: 0 10px; }

        /* å·¦å´ EP/SEP å€ */
        .ep-wrapper-left { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 20px; gap: 15px; }

        /* SEP (è¶…é€²åŒ–) æ°´æ™¶ */
        .sep-gem {
            width: 35px; height: 35px;
            background: #222; border: 2px solid #444;
            transform: rotate(45deg); 
            display: flex; justify-content: center; align-items: center;
            color: #555; font-size: 0.8rem; font-weight: bold;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
            cursor: pointer; /* è®“å®ƒçœ‹èµ·ä¾†å¯é»æ“Š */
        }
        .sep-gem span { transform: rotate(-45deg); font-size: 0.6rem; pointer-events: none; }
        
        /* SEP æ¿€æ´» (äº®ç´«) */
        .sep-gem.active {
            background: radial-gradient(circle at 30% 30%, #e040fb, #7b1fa2);
            border-color: #ff80ab;
            box-shadow: 0 0 15px #e040fb;
            color: white;
            animation: pulseSep 2s infinite;
        }
        
        /* SEP å·²ä½¿ç”¨ (è®Šæš—) */
        .sep-gem.used {
            background: #111;
            border-color: #444;
            box-shadow: none;
            color: #333;
            opacity: 0.5;
            animation: none;
        }

        @keyframes pulseSep { 0% {box-shadow: 0 0 10px #e040fb;} 50% {box-shadow: 0 0 20px #e040fb;} 100% {box-shadow: 0 0 10px #e040fb;} }

        /* EP å®¹å™¨ */
        .ep-container { display: flex; flex-direction: column-reverse; gap: 8px; }

        /* EP æ°´æ™¶ */
        .ep-gem {
            width: 24px; height: 24px;
            background: #333; border: 2px solid #555;
            transform: rotate(45deg); cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: all 0.2s; opacity: 0.3;
        }
        .ep-gem.has-ep { opacity: 1; background: #5a4a00; border-color: #887000; }
        .ep-gem.active {
            background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
            border-color: #ffffaa; box-shadow: 0 0 8px #ffd700;
        }

        /* ä¸­é–“å¤§åœ–èˆ‡ HP */
        .player-display-container { display: flex; flex-direction: column; align-items: center; position: relative; margin: 0 10px; }
        .avatar-large { width: 160px; height: 160px; border-radius: 50%; border: 4px solid #fff; object-fit: cover; background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.6); }
        .hp-text-large { font-size: 4.5rem; font-weight: 800; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8); position: absolute; bottom: -15px; right: -15px; z-index: 5; }
        
        .btn-hp { width: 60px; height: 60px; border-radius: 50%; font-size: 2rem; background: #444; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10; }
        .btn-minus { background: #b71c1c; }
        .btn-plus { background: #1b5e20; }
        
        .avatar-small { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #ccc; object-fit: cover; }
        .hp-text-small { font-size: 3rem; font-weight: bold; min-width: 60px; text-align: center; }

        .dice-container { position: absolute; bottom: 15px; right: 15px; z-index: 20; }
        .dice-btn { width: 50px; height: 50px; background: white; color: black; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; border: 2px solid #ccc; cursor: pointer; }
        .btn-rotate { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; font-size: 0.8rem; border: 1px solid #666; }
    </style>
</head>
<body>

<!-- ç•«é¢ 1: é¸æ“‡ -->
<div id="screen-select">
    <h2 style="color: #00d2ff; margin-bottom: 20px;">GAME SETUP</h2>
    
    <div class="order-selector">
        <div class="order-opt active" id="optFirst" onclick="setOrder('first')">å…ˆæ”» (1st)</div>
        <div class="order-opt" id="optSecond" onclick="setOrder('second')">å¾Œæ”» (2nd)</div>
    </div>

    <div class="grid">
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf')"><img src="https://via.placeholder.com/200/2E7D32/FFFFFF?text=Elf"><div class="class-label">ç²¾éˆ</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/FBC02D/000000?text=Royal')"><img src="https://via.placeholder.com/200/FBC02D/000000?text=Royal"><div class="class-label">çš‡å®¶</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch')"><img src="https://via.placeholder.com/200/1565C0/FFFFFF?text=Witch"><div class="class-label">å·«å¸«</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/E65100/FFFFFF?text=Drag')"><img src="https://via.placeholder.com/200/E65100/FFFFFF?text=Drag"><div class="class-label">é¾æ—</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/6A1B9A/FFFFFF?text=Necro')"><img src="https://via.placeholder.com/200/6A1B9A/FFFFFF?text=Necro"><div class="class-label">æ­»éˆ</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/B71C1C/FFFFFF?text=Blood')"><img src="https://via.placeholder.com/200/B71C1C/FFFFFF?text=Blood"><div class="class-label">å¸è¡€é¬¼</div></div>
        <div class="leader-opt" onclick="selectLeader(this, 'https://via.placeholder.com/200/F0F4C3/000000?text=Bishop')"><img src="https://via.placeholder.com/200/F0F4C3/000000?text=Bishop"><div class="class-label">ä¸»æ•™</div></div>
        <label class="leader-opt upload-btn" onclick="triggerUpload(this)">
            <span class="upload-icon">+</span>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleUpload(this)">
            <div class="class-label">ä¸Šå‚³åœ–ç‰‡</div>
        </label>
    </div>
    <button class="btn" style="background: #00d2ff; color: #000; padding: 15px 50px; font-size: 1.2rem; border-radius: 30px; margin-top: 20px;" onclick="startGame()">BATTLE START</button>
</div>

<!-- æˆ°é¬¥ç•«é¢ -->
<div id="screen-battle">
    <div class="left-panel-pp">
        <div class="pp-text-display">
            PP: <span class="pp-nums"><span id="currentPP">0</span>/<span id="maxPP">0</span></span>
        </div>
        
        <div class="pp-gauge-container" id="ppGauge"></div>

        <div class="controls-wrapper">
            <div class="pp-btn-row">
                <button class="btn btn-manual" onclick="modPP(-1)">PP -1</button>
                <button class="btn btn-manual" onclick="modPP(1)">PP +1</button>
            </div>
            <div class="pp-btn-row">
                <button class="btn btn-manual btn-max" onclick="modMaxPP(-1)">Max-</button>
                <button class="btn btn-manual btn-max" onclick="modMaxPP(1)">Max+</button>
            </div>
            <button class="btn btn-turn-start" onclick="startTurn()">å›åˆé–‹å§‹<br><span style="font-size: 0.8rem; font-weight: normal;">TURN START</span></button>
        </div>
        <div style="text-align: center; color: #666; font-size: 0.7rem; margin-top: 5px;">Turn: <span id="turnCount">0</span></div>
    </div>

    <div class="right-panel-hp">
        <div class="section-enemy" id="enemySection">
            <button class="btn btn-rotate" onclick="rotateEnemy()">â†»</button>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn btn-hp btn-minus" onclick="modHP('enemy', -1)">-</button>
                <div style="text-align: center;">
                    <img src="https://via.placeholder.com/150/333/FFF?text=Enemy" class="avatar-small">
                    <div class="hp-text-small" id="enemyHP">20</div>
                </div>
                <button class="btn btn-hp btn-plus" onclick="modHP('enemy', 1)">+</button>
            </div>
        </div>

        <div class="section-player">
            <div class="player-controls-container">
                
                <!-- å·¦å´ï¼šEP èˆ‡ SEP (å¯é»æ“Š) -->
                <div class="ep-wrapper-left">
                    <!-- SEP å¢åŠ  onclick -->
                    <div class="sep-gem" id="sepGem" onclick="toggleSEP(this)"><span>SEP</span></div>
                    
                    <div class="ep-container">
                        <div class="ep-gem" id="ep1" onclick="toggleEP(this)"></div>
                        <div class="ep-gem" id="ep2" onclick="toggleEP(this)"></div>
                        <div class="ep-gem" id="ep3" onclick="toggleEP(this)"></div>
                    </div>
                </div>

                <!-- ä¸­é–“ï¼šHP èˆ‡ é ­åƒ -->
                <button class="btn btn-hp btn-minus" onclick="modHP('player', -1)">-</button>
                <div class="player-display-container">
                    <img id="myAvatar" src="" class="avatar-large">
                    <div class="hp-text-large" id="playerHP">20</div>
                </div>
                <button class="btn btn-hp btn-plus" onclick="modHP('player', 1)">+</button>
            </div>
            
            <div class="dice-container" onclick="rollDice()"><div class="dice-btn" id="diceResult">ğŸ²</div></div>
        </div>
    </div>
</div>

<script>
    let state = { 
        playerHP: 20, enemyHP: 20, 
        currentPP: 0, maxPP: 0, 
        turn: 0, 
        imgSrc: '',
        isFirstPlayer: true, 
        epCount: 0,
        sepUsed: false // æ–°å¢ï¼šç´€éŒ„ SEP æ˜¯å¦å·²ä½¿ç”¨
    };

    function initGauge() {
        const container = document.getElementById('ppGauge');
        container.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            let gem = document.createElement('div');
            gem.className = 'pp-gem';
            gem.dataset.index = i;
            gem.innerText = i;
            gem.onclick = () => togglePP(i);
            container.appendChild(gem);
        }
        renderPP();
    }

    function setOrder(order) {
        state.isFirstPlayer = (order === 'first');
        document.getElementById('optFirst').className = state.isFirstPlayer ? 'order-opt active' : 'order-opt';
        document.getElementById('optSecond').className = !state.isFirstPlayer ? 'order-opt active' : 'order-opt';
    }

    function startGame() {
        if (!state.imgSrc) { alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼"); return; }
        state.epCount = state.isFirstPlayer ? 0 : 3;
        state.turn = 0; state.maxPP = 0; state.currentPP = 0;
        state.sepUsed = false; // é‡ç½® SEP ç‹€æ…‹

        updateEPUi();
        updateSEPUi(); 
        
        document.getElementById('myAvatar').src = state.imgSrc;
        document.getElementById('screen-select').style.display = 'none';
        document.getElementById('screen-battle').style.display = 'flex';
        document.getElementById('turnCount').innerText = 0;
        initGauge();
    }

    function startTurn() {
        state.turn++; 
        if(state.maxPP < 10) state.maxPP++;
        state.currentPP = state.maxPP;
        
        renderPP();
        document.getElementById('turnCount').innerText = state.turn;
        
        // æª¢æŸ¥ SEP è§£é–ç‹€æ…‹
        updateSEPUi();
    }

    // SEP é‚è¼¯æ›´æ–° (Source 5, 7)
    function updateSEPUi() {
        const sepGem = document.getElementById('sepGem');
        let canUse = false;
        
        // åˆ¤æ–·å›åˆæ•¸æ˜¯å¦é”æ¨™
        if (state.isFirstPlayer && state.turn >= 7) canUse = true;
        if (!state.isFirstPlayer && state.turn >= 6) canUse = true;

        // å¦‚æœå›åˆæœªé”æ¨™ -> ä¿æŒæœªæ¿€æ´»
        if (!canUse) {
            sepGem.className = 'sep-gem'; // ç§»é™¤ active å’Œ used
            return;
        }

        // å¦‚æœå›åˆé”æ¨™ï¼Œæª¢æŸ¥æ˜¯å¦å·²ä½¿ç”¨
        if (state.sepUsed) {
            sepGem.className = 'sep-gem used'; // è®Šæš—
        } else {
            sepGem.className = 'sep-gem active'; // äº®ç´«ç‡ˆ
        }
    }

    // SEP é»æ“Šåˆ‡æ›åŠŸèƒ½
    function toggleSEP(el) {
        // å¦‚æœé‚„æ²’è§£é– (æ—¢ä¸æ˜¯ active ä¹Ÿä¸æ˜¯ used)ï¼Œå‰‡ä¸èƒ½é»
        if (!el.classList.contains('active') && !el.classList.contains('used')) return;

        // åˆ‡æ›ç‹€æ…‹
        state.sepUsed = !state.sepUsed;
        updateSEPUi(); // æ›´æ–°è¦–è¦º
    }

    function updateEPUi() {
        for (let i = 1; i <= 3; i++) {
            const el = document.getElementById('ep' + i);
            el.classList.remove('has-ep', 'active');
            if (i <= state.epCount) el.classList.add('has-ep', 'active');
        }
    }

    function toggleEP(el) {
        if (!el.classList.contains('has-ep')) return;
        el.classList.toggle('active');
    }

    // åŸºç¤åŠŸèƒ½
    function togglePP(index) {
        if (state.currentPP >= index) state.currentPP = index - 1; 
        else state.currentPP = index;
        renderPP();
    }
    function modPP(val) {
        const next = state.currentPP + val;
        if(next >= 0 && next <= state.maxPP) { state.currentPP = next; renderPP(); }
    }
    function modMaxPP(val) {
        const next = state.maxPP + val;
        if(next >= 0 && next <= 10) { state.maxPP = next; if(state.currentPP > state.maxPP) state.currentPP = state.maxPP; renderPP(); }
    }
    function renderPP() {
        document.getElementById('currentPP').innerText = state.currentPP;
        document.getElementById('maxPP').innerText = state.maxPP;
        const gems = document.querySelectorAll('.pp-gem');
        gems.forEach(gem => {
            let idx = parseInt(gem.dataset.index);
            if (idx <= state.maxPP) {
                gem.style.display = 'flex';
                gem.className = (idx <= state.currentPP) ? 'pp-gem active' : 'pp-gem used';
            } else { gem.style.display = 'none'; }
        });
    }
    function selectLeader(el, src) {
        document.querySelectorAll('.leader-opt').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        state.imgSrc = src;
    }
    function triggerUpload(el) { document.querySelectorAll('.leader-opt').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
    function handleUpload(input) {
        // 1. ä¿®æ­£åˆ¤æ–·å¼ï¼Œä¸¦ç¢ºèªæœ‰é¸å–æª”æ¡ˆ
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // 2. å°‡è®€å–åˆ°çš„ Base64 åœ–ç‰‡å­˜å…¥ state
                state.imgSrc = e.target.result;
                
                // 3. è¦–è¦ºé è¦½ï¼šæ‰¾åˆ° label ä¸¦æ›èƒŒæ™¯
                const label = input.parentElement;
                label.style.backgroundImage = `url('${e.target.result}')`;
                label.style.backgroundSize = 'cover';
                label.style.backgroundPosition = 'center';
                
                // éš±è—åŠ è™Ÿåœ–æ¨™
                const icon = label.querySelector('.upload-icon');
                if (icon) icon.style.display = 'none';
                
                alert("åœ–ç‰‡è®€å–æˆåŠŸï¼è«‹æŒ‰ä¸‹ BATTLE START");
            }
            
            // 4. é—œéµä¿®æ­£ï¼šå¿…é ˆå‚³å…¥å…·é«”çš„æª”æ¡ˆç‰©ä»¶ [0]
            reader.readAsDataURL(input.files[0]);
        }
    }
    function modHP(who, val) {
        if(who === 'player') { state.playerHP += val; document.getElementById('playerHP').innerText = state.playerHP; }
        else { state.enemyHP += val; document.getElementById('enemyHP').innerText = state.enemyHP; }
    }
    function rollDice() {
        const dice = document.getElementById('diceResult');
        dice.style.transform = "rotate(360deg)";
        setTimeout(() => { dice.innerText = Math.floor(Math.random()*6)+1; dice.style.transform = "rotate(0deg)"; }, 250);
    }
    let isRotated = false;
    function rotateEnemy() {
        isRotated = !isRotated;
        document.getElementById('enemySection').style.transform = isRotated ? "rotate(180deg)" : "none";
    }
</script>
</body>
</html>
